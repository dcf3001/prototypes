{% extends "base.html" %}
{% block title %}Analyst Memory — Sovereign Ratings Agency{% endblock %}

{% block content %}
<h1 class="page-title">Analyst Memory</h1>
<p class="page-subtitle">
  Rationale notes from overrides — automatically injected into future AI ratings for tagged countries.
</p>

<div id="mem-msg" class="alert alert-info" style="display:none"></div>

{% if not memories %}
  <div class="empty card">No memories yet. Override a country's rating to create one.</div>
{% else %}
  <div style="font-size:14px;color:#546e7a;margin-bottom:16px">
    {{ memories|length }} memor{{ 'y' if memories|length == 1 else 'ies' }}
  </div>
  <div class="memories-grid">
    {% for m in memories %}
    <div class="memory-card" id="mem-{{ m.id }}">

      <div class="memory-title">{{ m.title }}</div>
      <div class="memory-meta">
        {% if m.country_name %}<span>{{ m.country_name }} · </span>{% endif %}
        {{ m.created_at|fmt_date }}
      </div>

      <!-- View mode -->
      <div class="memory-content" id="content-view-{{ m.id }}">{{ m.content }}</div>

      <!-- Edit mode (hidden) -->
      <div id="edit-mode-{{ m.id }}" style="display:none">
        <textarea class="form-control mb-2" id="edit-content-{{ m.id }}" style="min-height:80px">{{ m.content }}</textarea>
        <input class="form-control mb-2" id="edit-tags-{{ m.id }}"
               value="{{ m.tags|parse_json_tags|join(', ') }}"
               placeholder="Tags (comma-separated)">
        <label class="form-label" style="margin-bottom:6px">Applies to countries</label>
        <input class="form-control mb-1" placeholder="Search…"
               oninput="filterMemoryPicker('{{ m.id }}', this.value)">
        <div class="country-picker" id="picker-{{ m.id }}" style="max-height:120px">
          {% set applicable = m.applicable_country_ids|parse_json_tags %}
          {% for c in all_countries %}
          <div class="country-picker-item {% if c.id in applicable %}selected{% endif %}"
               data-id="{{ c.id }}" data-name="{{ c.name|lower }}"
               onclick="toggleMemoryCountry('{{ m.id }}', this)">
            <input type="checkbox" style="flex-shrink:0;pointer-events:none"
                   {% if c.id in applicable %}checked{% endif %}>
            <span>{{ c.name }}</span>
            <span style="font-size:11px;color:#9e9e9e;margin-left:auto">{{ c.iso2 }}</span>
          </div>
          {% endfor %}
        </div>
      </div>

      {% set tags = m.tags|parse_json_tags %}
      {% if tags %}
      <div class="memory-tags" id="tags-view-{{ m.id }}">
        {% for t in tags %}<span class="memory-tag">{{ t }}</span>{% endfor %}
      </div>
      {% endif %}

      {% set applicable_ids = m.applicable_country_ids|parse_json_tags %}
      {% set applicable_names = [] %}
      {% for c in all_countries %}
        {% if c.id in applicable_ids %}{% set _ = applicable_names.append(c.name) %}{% endif %}
      {% endfor %}
      {% if applicable_names %}
      <div class="memory-countries">Also applies to: {{ applicable_names|join(', ') }}</div>
      {% endif %}

      <div class="memory-actions">
        <button id="edit-btn-{{ m.id }}" class="btn btn-outline btn-sm"
                onclick="startEdit('{{ m.id }}')">Edit</button>
        <button id="save-btn-{{ m.id }}" class="btn btn-blue btn-sm"
                onclick="saveEdit('{{ m.id }}')" style="display:none">Save</button>
        <button id="cancel-btn-{{ m.id }}" class="btn btn-outline btn-sm"
                onclick="cancelEdit('{{ m.id }}')" style="display:none">Cancel</button>
        <button class="btn btn-sm" style="background:#fce4ec;color:#c62828"
                onclick="deleteMemory('{{ m.id }}', '{{ m.title|replace("'","\\'")|e }}')">Delete</button>
      </div>
    </div>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function filterMemoryPicker(memId, q) {
  document.querySelectorAll(`#picker-${memId} .country-picker-item`).forEach(item => {
    item.style.display = !q || item.dataset.name.includes(q.toLowerCase()) ? '' : 'none';
  });
}

function toggleMemoryCountry(memId, el) {
  el.classList.toggle('selected');
  el.querySelector('input').checked = el.classList.contains('selected');
}

function startEdit(id) {
  document.getElementById(`content-view-${id}`).style.display = 'none';
  document.getElementById(`edit-mode-${id}`).style.display = 'block';
  document.getElementById(`edit-btn-${id}`).style.display = 'none';
  document.getElementById(`save-btn-${id}`).style.display = '';
  document.getElementById(`cancel-btn-${id}`).style.display = '';
  const tagsEl = document.getElementById(`tags-view-${id}`);
  if (tagsEl) tagsEl.style.display = 'none';
}

function cancelEdit(id) {
  document.getElementById(`content-view-${id}`).style.display = '';
  document.getElementById(`edit-mode-${id}`).style.display = 'none';
  document.getElementById(`edit-btn-${id}`).style.display = '';
  document.getElementById(`save-btn-${id}`).style.display = 'none';
  document.getElementById(`cancel-btn-${id}`).style.display = 'none';
  const tagsEl = document.getElementById(`tags-view-${id}`);
  if (tagsEl) tagsEl.style.display = '';
}

async function saveEdit(id) {
  const content = document.getElementById(`edit-content-${id}`).value.trim();
  const tagsStr = document.getElementById(`edit-tags-${id}`).value;
  const tags = tagsStr.split(',').map(t => t.trim()).filter(Boolean);
  const selectedIds = [...document.querySelectorAll(`#picker-${id} .country-picker-item.selected`)]
    .map(el => parseInt(el.dataset.id));

  const btn = document.getElementById(`save-btn-${id}`);
  btn.disabled = true;
  btn.textContent = 'Saving…';

  try {
    const r = await fetch(`/api/rationale/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, tags, applicable_country_ids: selectedIds }),
    });
    if (!r.ok) throw new Error(r.statusText);
    location.reload();
  } catch(e) {
    showMsg('Save failed: ' + e.message, true);
    btn.disabled = false;
    btn.textContent = 'Save';
  }
}

async function deleteMemory(id, title) {
  if (!confirm(`Delete memory "${title}"?`)) return;
  try {
    const r = await fetch(`/api/rationale/${id}`, { method: 'DELETE' });
    if (!r.ok) throw new Error(r.statusText);
    const card = document.getElementById(`mem-${id}`);
    card.style.opacity = '0';
    card.style.transition = 'opacity 0.3s';
    setTimeout(() => card.remove(), 300);
  } catch(e) {
    showMsg('Delete failed: ' + e.message, true);
  }
}

function showMsg(text, isError) {
  const el = document.getElementById('mem-msg');
  el.className = 'alert ' + (isError ? 'alert-error' : 'alert-info');
  el.textContent = text;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}{{ country.name }} — Sovereign Ratings Agency{% endblock %}

{% block content %}
{% set pa = country.pillar_analysis | parse_json if country.pillar_analysis else {} %}
{% set f  = fundamentals[0] if fundamentals else none %}

<a href="/" style="color:var(--blue);font-size:0.7rem;display:inline-block;margin-bottom:14px;letter-spacing:0.04em">← Dashboard</a>

<!-- ═══ HEADER CARD ══════════════════════════════════════════════════════════ -->
<div class="card mb-4" style="border-top:3px solid {{ country.rating|rating_color if country.rating else 'var(--border2)' }}">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px">
    <div style="flex:1;min-width:0">
      <h1 style="font-size:1.9rem;font-weight:700;color:var(--ink);margin-bottom:4px;font-family:'Playfair Display',serif">{{ country.name }}</h1>
      <div style="font-size:0.68rem;color:var(--ink3);margin-bottom:12px;font-family:'JetBrains Mono',monospace;letter-spacing:0.04em">
        {{ country.iso2 }} &nbsp;·&nbsp; {{ country.iso3 }} &nbsp;·&nbsp;
        {{ country.region or 'Unknown region' }} &nbsp;·&nbsp;
        {{ country.income_group or 'Unknown income group' }}
      </div>

      <!-- Rating row -->
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
        {% if country.rating %}
          <span class="rating-badge" style="background:{{ country.rating|rating_color }};font-size:1.2rem;padding:5px 14px">
            {{ country.rating }}
          </span>
          {% if country.outlook %}
            <span class="outlook-badge" style="{{ country.outlook|outlook_style }};padding:4px 10px;font-size:0.65rem">
              {{ country.outlook }}
            </span>
          {% endif %}
          <span style="font-size:0.72rem;color:var(--ink3);font-family:'JetBrains Mono',monospace">
            Score: <strong style="color:var(--ink)">{{ country.composite_score|fmt_num(1) }}</strong> / 100
          </span>
          <span style="font-size:0.62rem;padding:2px 8px;border-radius:2px;
            background:{% if country.rating|rating_category=='Investment Grade' %}var(--green-bg){% elif country.rating|rating_category=='Sub-Investment Grade' %}var(--amber-bg){% else %}var(--red-bg){% endif %};
            color:{% if country.rating|rating_category=='Investment Grade' %}var(--green){% elif country.rating|rating_category=='Sub-Investment Grade' %}var(--amber){% else %}var(--red){% endif %};
            border:1px solid {% if country.rating|rating_category=='Investment Grade' %}var(--green-bdr){% elif country.rating|rating_category=='Sub-Investment Grade' %}var(--amber-bdr){% else %}var(--red-bdr){% endif %}">
            {{ country.rating|rating_category }}
          </span>
          {% if country.source %}
            <span style="font-size:0.6rem;color:{% if country.source=='override' %}var(--amber){% else %}var(--ink3){% endif %};font-style:italic;font-family:'JetBrains Mono',monospace">
              [{{ country.source }}{% if country.rated_at %} · {{ country.rated_at|fmt_date }}{% endif %}]
            </span>
          {% endif %}
        {% else %}
          <span class="rating-badge-nr" style="font-size:1rem;padding:4px 12px">Not Rated</span>
        {% endif %}
      </div>

      <!-- Rationale snippet -->
      {% set rationale_text = country.override_rationale or country.ai_rationale %}
      {% if rationale_text %}
        <div style="background:var(--blue-bg);border-left:3px solid var(--blue-bdr);border-radius:0 2px 2px 0;padding:10px 14px;font-size:0.72rem;color:var(--ink2);line-height:1.75;max-width:720px;font-family:'Playfair Display',serif;font-style:italic">
          {{ rationale_text }}
        </div>
      {% endif %}
    </div>

    <!-- Action buttons -->
    <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;align-items:flex-end">
      <button id="rerate-btn" class="btn btn-blue" onclick="rerateWithAI('{{ country.iso2 }}')">
        ⟳ Re-rate with AI
      </button>
      <button class="btn btn-orange" onclick="openOverrideModal()">Override Rating</button>
      <button class="btn btn-gray btn-sm" onclick="syncFundamentals('{{ country.iso2 }}')">Sync World Bank</button>
      <button class="btn btn-gray btn-sm" onclick="fetchNews('{{ country.iso2 }}')">Fetch News</button>
    </div>
  </div>
</div>

<!-- Action message bar -->
<div id="action-msg" class="alert alert-info" style="display:none;margin-bottom:14px"></div>

<!-- ═══ TAB NAV ═══════════════════════════════════════════════════════════════ -->
<div class="tabs" style="overflow-x:auto;white-space:nowrap">
  <button class="tab-btn active" onclick="switchTab('summary',this)">Summary</button>
  <button class="tab-btn" onclick="switchTab('economy',this)">Economy</button>
  <button class="tab-btn" onclick="switchTab('fiscal',this)">Fiscal</button>
  <button class="tab-btn" onclick="switchTab('external',this)">External</button>
  <button class="tab-btn" onclick="switchTab('monetary',this)">Monetary</button>
  <button class="tab-btn" onclick="switchTab('banking',this)">Banking</button>
  <button class="tab-btn" onclick="switchTab('politics',this)">Politics</button>
  <button class="tab-btn" onclick="switchTab('history',this)">History</button>
  <button class="tab-btn" onclick="switchTab('news',this)">News</button>
</div>


<!-- ═══ SUMMARY TAB ══════════════════════════════════════════════════════════ -->
<div id="tab-summary" class="tab-panel active card" style="border-top:none;border-radius:0 0 2px 2px">
  {% if country.rating %}
    <h3 style="font-size:0.55rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:0.2em;margin-bottom:18px">Pillar Scorecard</h3>
    {% set pillars = [
      ('Economic Strength',   country.score_economic,  '#1a3878', 'economy'),
      ('Fiscal Position',     country.score_fiscal,    '#5a2d82', 'fiscal'),
      ('External Position',   country.score_external,  '#1a6830', 'external'),
      ('Monetary Policy',     country.score_monetary,  '#b06010', 'monetary'),
      ('Banking Sector',      country.score_banking,   '#b02020', 'banking'),
      ('Political Governance',country.score_political, '#1a6830', 'politics'),
    ] %}
    {% for label, score, color, tab_id in pillars %}
    {% set lvl = score_label(score) %}
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;cursor:pointer"
         onclick="switchTab('{{ tab_id }}', document.querySelector('.tab-btn[onclick*=\\'{{ tab_id }}\\']'))">
      <span style="width:170px;font-size:0.72rem;color:var(--ink2);font-weight:600;flex-shrink:0">{{ label }}</span>
      <div style="flex:1;height:8px;background:var(--bg3);border-radius:1px;overflow:hidden">
        <div style="height:100%;width:{{ score|fmt_num(0,'','') if score is not none else 0 }}%;background:{{ color }};border-radius:1px;transition:width .5s"></div>
      </div>
      <span style="width:28px;font-size:0.75rem;font-weight:700;font-family:'JetBrains Mono',monospace;text-align:right;color:var(--ink)">{{ score|fmt_num(0) }}</span>
      <span style="width:70px;font-size:0.58rem;font-weight:600;padding:2px 7px;border-radius:2px;
                   background:{{ lvl[1] }}22;color:{{ lvl[1] }};text-align:center;letter-spacing:0.04em">{{ lvl[0] }}</span>
    </div>
    {% endfor %}
    <p style="font-size:0.6rem;color:var(--ink3);margin-top:14px;letter-spacing:0.04em">Click any row to open that pillar's detail tab.</p>
  {% else %}
    <div class="empty">No rating yet — click "Re-rate with AI" to generate one.</div>
  {% endif %}
</div>


<!-- ═══ PILLAR MACRO (inline, repeated for each pillar) ════════════════════ -->

{% macro pillar_tab(tab_id, label, score, color, metrics, pa_key) %}
<div id="tab-{{ tab_id }}" class="tab-panel" style="border-top:none">

  <!-- Score hero -->
  {% set lvl = score_label(score) %}
  <div style="background:var(--bg2);border-radius:2px;padding:20px;margin-bottom:20px;border-left:4px solid {{ color }};border:1px solid var(--border);border-left:4px solid {{ color }}">
    <div style="font-size:0.55rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:0.2em;margin-bottom:6px">{{ label }}</div>
    <div style="display:flex;align-items:baseline;gap:6px;margin-bottom:10px">
      <span style="font-size:3.5rem;font-weight:700;line-height:1;color:{{ color }};font-family:'JetBrains Mono',monospace">{{ score|fmt_num(0) }}</span>
      <span style="font-size:1.2rem;color:var(--ink3);font-weight:400;font-family:'JetBrains Mono',monospace">/100</span>
      <span style="margin-left:8px;font-size:0.62rem;font-weight:600;padding:3px 10px;border-radius:2px;
                   background:{{ lvl[1] }}22;color:{{ lvl[1] }};letter-spacing:0.06em">{{ lvl[0] }}</span>
    </div>
    <div style="height:6px;background:var(--bg3);border-radius:1px;overflow:hidden">
      <div style="height:100%;width:{{ score|fmt_num(0,'','') if score is not none else 0 }}%;background:{{ color }};border-radius:1px;transition:width .6s"></div>
    </div>
  </div>

  <!-- Data metrics grid -->
  {% if metrics %}
  <div class="fundamentals-grid mb-4">
    {% for mlabel, mvalue in metrics %}
    <div class="fundamental-card">
      <div class="fundamental-label">{{ mlabel }}</div>
      <div class="fundamental-value" style="font-size:1.1rem">{{ mvalue }}</div>
      {% if f %}<div class="fundamental-year">{{ f.year }}</div>{% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- AI analysis -->
  {% set analysis = pa.get(pa_key, {}) %}
  {% if analysis and analysis.get('summary') %}
    <div style="background:var(--blue-bg);border:1px solid var(--blue-bdr);border-radius:2px;padding:18px;margin-bottom:18px">
      <div style="font-size:0.55rem;font-weight:600;color:var(--blue);text-transform:uppercase;letter-spacing:0.2em;margin-bottom:12px">Analysis</div>
      {% for para in analysis.get('summary','').split('\n\n') %}
        {% if para.strip() %}
          <p style="font-size:0.82rem;line-height:1.85;color:var(--ink2);margin-bottom:12px;font-family:'Playfair Display',serif;font-style:italic">{{ para.strip() }}</p>
        {% endif %}
      {% endfor %}
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <!-- Strengths -->
      <div style="background:var(--green-bg);border:1px solid var(--green-bdr);border-radius:2px;padding:16px">
        <div style="font-size:0.6rem;font-weight:700;color:var(--green);margin-bottom:10px;letter-spacing:0.12em;text-transform:uppercase">Strengths</div>
        <ul style="list-style:none">
          {% for s in analysis.get('strengths', []) %}
          <li style="font-size:0.72rem;line-height:1.55;margin-bottom:7px;padding-left:16px;position:relative;color:var(--ink2)">
            <span style="position:absolute;left:0;color:var(--green);font-weight:700">✓</span>{{ s }}
          </li>
          {% endfor %}
        </ul>
      </div>
      <!-- Risks -->
      <div style="background:var(--red-bg);border:1px solid var(--red-bdr);border-radius:2px;padding:16px">
        <div style="font-size:0.6rem;font-weight:700;color:var(--red);margin-bottom:10px;letter-spacing:0.12em;text-transform:uppercase">Risks</div>
        <ul style="list-style:none">
          {% for r in analysis.get('risks', []) %}
          <li style="font-size:0.72rem;line-height:1.55;margin-bottom:7px;padding-left:16px;position:relative;color:var(--ink2)">
            <span style="position:absolute;left:0;color:var(--red);font-weight:700">!</span>{{ r }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% else %}
    <div class="empty" style="padding:28px;border:1px solid var(--border);border-radius:2px;background:var(--surface)">
      No detailed analysis yet — click <strong>Re-rate with AI</strong> to generate pillar-level commentary.
    </div>
  {% endif %}
</div>
{% endmacro %}


<!-- ═══ ECONOMY TAB ══════════════════════════════════════════════════════════ -->
{{ pillar_tab(
  'economy', 'Economic Strength', country.score_economic, '#1a3878',
  [
    ('GDP Growth',      f.gdp_growth  | fmt_num(1, '%')   if f else '—'),
    ('GDP per Capita',  f.gdp_per_capita | fmt_num(0, '', '$') if f else '—'),
    ('Inflation',       f.inflation   | fmt_num(1, '%')   if f else '—'),
  ],
  'economic_strength'
) }}


<!-- ═══ FISCAL TAB ═══════════════════════════════════════════════════════════ -->
{{ pillar_tab(
  'fiscal', 'Fiscal Position', country.score_fiscal, '#5a2d82',
  [
    ('Debt / GDP',      f.debt_gdp    | fmt_num(1, '%')   if f else '—'),
    ('Deficit / GDP',   f.deficit_gdp | fmt_num(1, '%')   if f else '—'),
  ],
  'fiscal_position'
) }}


<!-- ═══ EXTERNAL TAB ═════════════════════════════════════════════════════════ -->
{{ pillar_tab(
  'external', 'External Position', country.score_external, '#1a6830',
  [
    ('Current Account / GDP', f.ca_gdp          | fmt_num(1, '%')     if f else '—'),
    ('FX Reserves',           f.reserves_months | fmt_num(1, ' months') if f else '—'),
  ],
  'external_position'
) }}


<!-- ═══ MONETARY TAB ══════════════════════════════════════════════════════════ -->
{{ pillar_tab(
  'monetary', 'Monetary Policy', country.score_monetary, '#b06010',
  [
    ('Inflation',   f.inflation       | fmt_num(1, '%')     if f else '—'),
    ('FX Reserves', f.reserves_months | fmt_num(1, ' months') if f else '—'),
  ],
  'monetary_policy'
) }}


<!-- ═══ BANKING TAB ═══════════════════════════════════════════════════════════ -->
{{ pillar_tab(
  'banking', 'Banking Sector', country.score_banking, '#b02020',
  [],
  'banking_sector'
) }}


<!-- ═══ POLITICS TAB ══════════════════════════════════════════════════════════ -->
{{ pillar_tab(
  'politics', 'Political Governance', country.score_political, '#1a6830',
  [],
  'political_governance'
) }}


<!-- ═══ HISTORY TAB ═══════════════════════════════════════════════════════════ -->
<div id="tab-history" class="tab-panel card" style="border-top:none;border-radius:0 0 2px 2px">
  {% if history %}
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Rating</th><th>Outlook</th>
          <th>Score</th><th>Econ</th><th>Fiscal</th><th>Ext</th><th>Mon</th><th>Bank</th><th>Pol</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody>
        {% for r in history %}
        <tr {% if loop.first %}style="background:var(--blue-bg)"{% endif %}>
          <td class="text-mono" style="font-size:0.65rem;white-space:nowrap">
            {{ r.created_at|fmt_date }}
            {% if loop.first %}<span style="margin-left:5px;font-size:0.55rem;background:var(--blue);color:#fff;padding:1px 5px;border-radius:2px;letter-spacing:0.04em">NOW</span>{% endif %}
          </td>
          <td><span class="rating-badge" style="background:{{ r.rating|rating_color }}">{{ r.rating }}</span></td>
          <td>{% if r.outlook %}<span class="outlook-badge" style="{{ r.outlook|outlook_style }}">{{ r.outlook }}</span>{% else %}—{% endif %}</td>
          <td class="text-mono" style="font-size:0.7rem">{{ r.composite_score|fmt_num(1) }}</td>
          <td class="text-mono" style="font-size:0.65rem;color:var(--ink3)">{{ r.score_economic|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:0.65rem;color:var(--ink3)">{{ r.score_fiscal|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:0.65rem;color:var(--ink3)">{{ r.score_external|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:0.65rem;color:var(--ink3)">{{ r.score_monetary|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:0.65rem;color:var(--ink3)">{{ r.score_banking|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:0.65rem;color:var(--ink3)">{{ r.score_political|fmt_num(0) }}</td>
          <td style="font-size:0.65rem;color:{% if r.source=='override' %}var(--amber){% else %}var(--ink3){% endif %}">{{ r.source }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="empty">No rating history yet.</div>
  {% endif %}
</div>


<!-- ═══ NEWS TAB ══════════════════════════════════════════════════════════════ -->
<div id="tab-news" class="tab-panel card" style="border-top:none;border-radius:0 0 2px 2px">
  {% if news %}
    {% for a in news %}
    <div class="news-item">
      <div class="news-headline">
        {% if a.url %}<a href="{{ a.url }}" target="_blank" rel="noopener" style="color:var(--ink)">{{ a.headline }}</a>
        {% else %}{{ a.headline }}{% endif %}
      </div>
      <div class="news-meta">
        {% if a.source %}<span>{{ a.source }}</span>{% endif %}
        {% if a.published_at %}<span>{{ a.published_at|fmt_date }}</span>{% endif %}
        {% if a.sentiment is not none %}
          {% set s = a.sentiment %}
          <span class="{% if s > 0.1 %}sentiment-pos{% elif s < -0.1 %}sentiment-neg{% else %}sentiment-neu{% endif %}">
            {% if s > 0 %}+{% endif %}{{ "%.2f"|format(s) }}
          </span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="empty">No news cached yet. Click "Fetch News" in the top-right.</div>
  {% endif %}
</div>


<!-- ═══ OVERRIDE MODAL ═══════════════════════════════════════════════════════ -->
<div id="override-modal" class="modal-overlay" onclick="if(event.target===this)closeOverrideModal()">
  <div class="modal">
    <h2>Override Rating — {{ country.name }}</h2>
    <div id="override-error" class="alert alert-error" style="display:none"></div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Rating</label>
        <select id="ov-rating" class="form-control">
          {% for r in ratings_scale %}<option value="{{ r }}"{% if r==country.rating %} selected{% endif %}>{{ r }}</option>{% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Outlook</label>
        <select id="ov-outlook" class="form-control">
          {% for o in outlooks %}<option value="{{ o }}"{% if o==country.outlook %} selected{% endif %}>{{ o }}</option>{% endfor %}
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Memory Title <span style="color:var(--ink3);font-weight:400">(optional)</span></label>
      <input id="ov-title" class="form-control" placeholder="Override: {{ country.name }} — …">
    </div>

    <div class="form-group">
      <label class="form-label">Rationale <span style="color:var(--red)">*</span></label>
      <textarea id="ov-rationale" class="form-control" placeholder="Explain the reasoning for this rating override…"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Tags <span style="color:var(--ink3);font-weight:400">(comma-separated)</span></label>
      <input id="ov-tags" class="form-control" placeholder="e.g. sanctions, geopolitical, fiscal">
    </div>

    <div class="form-group">
      <label class="form-label">Also apply this rationale to (<span id="selected-count">0</span> selected)</label>
      <input id="country-search" class="form-control" placeholder="Search countries…"
             oninput="filterCountryPicker(this.value)" style="margin-bottom:6px">
      <div class="country-picker">
        {% for c in all_countries %}
        <div class="country-picker-item" data-id="{{ c.id }}" data-name="{{ c.name|lower }}"
             onclick="toggleCountry(this)">
          <input type="checkbox" style="flex-shrink:0;pointer-events:none">
          <span>{{ c.name }}</span>
          <span style="font-size:0.6rem;color:var(--ink3);margin-left:auto;font-family:'JetBrains Mono',monospace">{{ c.iso2 }}</span>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="flex gap-2 justify-between mt-4" style="padding-top:14px;border-top:1px solid var(--border)">
      <button class="btn btn-outline" onclick="closeOverrideModal()">Cancel</button>
      <button class="btn btn-orange" id="ov-submit" onclick="submitOverride('{{ country.iso2 }}')">Save Override</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById('tab-' + name);
  if (panel) panel.classList.add('active');
  if (btn) btn.classList.add('active');
  // Animate pillar bars into view
  panel && panel.querySelectorAll('[style*="width:"]').forEach(el => {
    const w = el.style.width; el.style.width='0'; setTimeout(()=>el.style.width=w, 50);
  });
}

// Open correct tab from URL hash
const tabFromHash = location.hash.replace('#','');
if (tabFromHash) {
  const btn = [...document.querySelectorAll('.tab-btn')].find(b => b.getAttribute('onclick').includes("'"+tabFromHash+"'"));
  if (btn) switchTab(tabFromHash, btn);
}

async function rerateWithAI(iso2) {
  const btn = document.getElementById('rerate-btn');
  const msg = document.getElementById('action-msg');
  btn.disabled = true; btn.textContent = '⟳ Rating…';
  msg.className = 'alert alert-info';
  msg.textContent = 'Sending to GPT-4o… this takes ~5 seconds.';
  msg.style.display = 'block';
  try {
    const r = await fetch(`/api/ratings/${iso2}/ai`, {method:'POST'});
    if (!r.ok) { const e = await r.json(); throw new Error(e.detail || r.statusText); }
    msg.textContent = 'Done! Reloading…';
    setTimeout(() => location.reload(), 600);
  } catch(e) {
    msg.className = 'alert alert-error';
    msg.textContent = 'Error: ' + e.message;
    btn.disabled = false; btn.textContent = '⟳ Re-rate with AI';
  }
}

async function syncFundamentals(iso2) {
  const msg = document.getElementById('action-msg');
  msg.className = 'alert alert-info';
  msg.textContent = 'Syncing World Bank data…';
  msg.style.display = 'block';
  try {
    const r = await fetch(`/api/fundamentals/sync/${iso2}`, {method:'POST'});
    if (!r.ok) throw new Error(r.statusText);
    msg.textContent = 'Sync complete. Reloading…';
    setTimeout(() => location.reload(), 600);
  } catch(e) {
    msg.className = 'alert alert-error';
    msg.textContent = 'Sync failed: ' + e.message;
  }
}

async function fetchNews(iso2) {
  const msg = document.getElementById('action-msg');
  msg.className = 'alert alert-info';
  msg.textContent = 'Fetching news…';
  msg.style.display = 'block';
  try {
    const r = await fetch(`/api/news/fetch/${iso2}`, {method:'POST'});
    if (!r.ok) throw new Error(r.statusText);
    const d = await r.json();
    msg.textContent = `Fetched ${d.fetched} articles. Reloading…`;
    setTimeout(() => { location.hash='news'; location.reload(); }, 600);
  } catch(e) {
    msg.className = 'alert alert-error';
    msg.textContent = 'Fetch failed: ' + e.message;
  }
}

function openOverrideModal()  { document.getElementById('override-modal').classList.add('open'); }
function closeOverrideModal() { document.getElementById('override-modal').classList.remove('open'); }

function filterCountryPicker(q) {
  document.querySelectorAll('.country-picker-item').forEach(el => {
    el.style.display = !q || el.dataset.name.includes(q.toLowerCase()) ? '' : 'none';
  });
}

function toggleCountry(el) {
  el.classList.toggle('selected');
  el.querySelector('input').checked = el.classList.contains('selected');
  document.getElementById('selected-count').textContent =
    document.querySelectorAll('.country-picker-item.selected').length;
}

async function submitOverride(iso2) {
  const rationale = document.getElementById('ov-rationale').value.trim();
  const errEl = document.getElementById('override-error');
  if (!rationale) { errEl.textContent='Rationale is required.'; errEl.style.display='block'; return; }
  errEl.style.display = 'none';

  const selectedIds = [...document.querySelectorAll('.country-picker-item.selected')]
    .map(el => parseInt(el.dataset.id));

  const body = {
    rating:   document.getElementById('ov-rating').value,
    outlook:  document.getElementById('ov-outlook').value,
    title:    document.getElementById('ov-title').value.trim() || undefined,
    rationale,
    tags: document.getElementById('ov-tags').value.split(',').map(t=>t.trim()).filter(Boolean),
    applicable_country_ids: selectedIds,
  };

  const btn = document.getElementById('ov-submit');
  btn.disabled = true; btn.textContent = 'Saving…';
  try {
    const r = await fetch(`/api/ratings/${iso2}/override`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    if (!r.ok) { const e = await r.json(); throw new Error(e.detail || r.statusText); }
    location.reload();
  } catch(e) {
    errEl.textContent = 'Error: ' + e.message;
    errEl.style.display = 'block';
    btn.disabled = false; btn.textContent = 'Save Override';
  }
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}{{ country.name }} ‚Äî Sovereign Ratings Agency{% endblock %}

{% block content %}
{% set pa = country.pillar_analysis | parse_json if country.pillar_analysis else {} %}
{% set f  = fundamentals[0] if fundamentals else none %}

<a href="/" style="color:#1565c0;font-size:14px;display:inline-block;margin-bottom:16px">‚Üê Dashboard</a>

<!-- ‚ïê‚ïê‚ïê HEADER CARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="card mb-4" style="border-top:4px solid {{ country.rating|rating_color if country.rating else '#9e9e9e' }}">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px">
    <div style="flex:1;min-width:0">
      <h1 style="font-size:30px;font-weight:900;color:#0a1929;margin-bottom:4px">{{ country.name }}</h1>
      <div style="font-size:13px;color:#546e7a;margin-bottom:14px">
        {{ country.iso2 }} &nbsp;¬∑&nbsp; {{ country.iso3 }} &nbsp;¬∑&nbsp;
        {{ country.region or 'Unknown region' }} &nbsp;¬∑&nbsp;
        {{ country.income_group or 'Unknown income group' }}
      </div>

      <!-- Rating row -->
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px">
        {% if country.rating %}
          <span class="rating-badge" style="background:{{ country.rating|rating_color }};font-size:22px;padding:6px 16px">
            {{ country.rating }}
          </span>
          {% if country.outlook %}
            <span class="outlook-badge" style="{{ country.outlook|outlook_style }};padding:5px 12px;font-size:13px">
              {{ country.outlook }}
            </span>
          {% endif %}
          <span style="font-size:14px;color:#546e7a;font-family:monospace">
            Score: <strong>{{ country.composite_score|fmt_num(1) }}</strong> / 100
          </span>
          <span style="font-size:12px;padding:3px 8px;border-radius:4px;
            background:{% if country.rating|rating_category=='Investment Grade' %}#e8f5e9{% elif country.rating|rating_category=='Sub-Investment Grade' %}#fff8e1{% else %}#fce4ec{% endif %};
            color:{% if country.rating|rating_category=='Investment Grade' %}#2e7d32{% elif country.rating|rating_category=='Sub-Investment Grade' %}#f57f17{% else %}#c62828{% endif %}">
            {{ country.rating|rating_category }}
          </span>
          {% if country.source %}
            <span style="font-size:11px;color:{% if country.source=='override' %}#e65100{% else %}#9e9e9e{% endif %};font-style:italic">
              [{{ country.source }}{% if country.rated_at %} ¬∑ {{ country.rated_at|fmt_date }}{% endif %}]
            </span>
          {% endif %}
        {% else %}
          <span class="rating-badge-nr" style="font-size:18px;padding:5px 14px">Not Rated</span>
        {% endif %}
      </div>

      <!-- Rationale snippet -->
      {% set rationale_text = country.override_rationale or country.ai_rationale %}
      {% if rationale_text %}
        <div style="background:#f8fafc;border-left:3px solid #90caf9;border-radius:0 6px 6px 0;padding:10px 14px;font-size:13px;color:#2d3748;line-height:1.7;max-width:720px">
          {{ rationale_text }}
        </div>
      {% endif %}
    </div>

    <!-- Action buttons -->
    <div style="display:flex;flex-direction:column;gap:8px;flex-shrink:0;align-items:flex-end">
      <button id="rerate-btn" class="btn btn-blue" onclick="rerateWithAI('{{ country.iso2 }}')">
        ‚ü≥ Re-rate with AI
      </button>
      <button class="btn btn-orange" onclick="openOverrideModal()">Override Rating</button>
      <button class="btn btn-gray btn-sm" onclick="syncFundamentals('{{ country.iso2 }}')">Sync World Bank</button>
      <button class="btn btn-gray btn-sm" onclick="fetchNews('{{ country.iso2 }}')">Fetch News</button>
    </div>
  </div>
</div>

<!-- Action message bar -->
<div id="action-msg" class="alert alert-info" style="display:none;margin-bottom:16px"></div>

<!-- ‚ïê‚ïê‚ïê TAB NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tabs" style="overflow-x:auto;white-space:nowrap">
  <button class="tab-btn active" onclick="switchTab('summary',this)">Summary</button>
  <button class="tab-btn" onclick="switchTab('economy',this)">Economy</button>
  <button class="tab-btn" onclick="switchTab('fiscal',this)">Fiscal</button>
  <button class="tab-btn" onclick="switchTab('external',this)">External</button>
  <button class="tab-btn" onclick="switchTab('monetary',this)">Monetary</button>
  <button class="tab-btn" onclick="switchTab('banking',this)">Banking</button>
  <button class="tab-btn" onclick="switchTab('politics',this)">Politics</button>
  <button class="tab-btn" onclick="switchTab('history',this)">History</button>
  <button class="tab-btn" onclick="switchTab('news',this)">News</button>
</div>


<!-- ‚ïê‚ïê‚ïê SUMMARY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-summary" class="tab-panel active card">
  {% if country.rating %}
    <h3 style="font-size:13px;font-weight:700;color:#546e7a;text-transform:uppercase;letter-spacing:1px;margin-bottom:20px">Pillar Scorecard</h3>
    {% set pillars = [
      ('Economic Strength',   country.score_economic,  '#1565c0', 'economy'),
      ('Fiscal Position',     country.score_fiscal,    '#6a1b9a', 'fiscal'),
      ('External Position',   country.score_external,  '#00695c', 'external'),
      ('Monetary Policy',     country.score_monetary,  '#e65100', 'monetary'),
      ('Banking Sector',      country.score_banking,   '#c62828', 'banking'),
      ('Political Governance',country.score_political, '#2e7d32', 'politics'),
    ] %}
    {% for label, score, color, tab_id in pillars %}
    {% set lvl = score_label(score) %}
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px;cursor:pointer"
         onclick="switchTab('{{ tab_id }}', document.querySelector('.tab-btn[onclick*=\\'{{ tab_id }}\\']'))">
      <span style="width:170px;font-size:13px;color:#2d3748;font-weight:600;flex-shrink:0">{{ label }}</span>
      <div style="flex:1;height:12px;background:#e0e0e0;border-radius:6px;overflow:hidden">
        <div style="height:100%;width:{{ score|fmt_num(0,'','') if score is not none else 0 }}%;background:{{ color }};border-radius:6px;transition:width .5s"></div>
      </div>
      <span style="width:28px;font-size:14px;font-weight:800;font-family:monospace;text-align:right">{{ score|fmt_num(0) }}</span>
      <span style="width:70px;font-size:11px;font-weight:600;padding:2px 7px;border-radius:4px;
                   background:{{ lvl[1] }}22;color:{{ lvl[1] }};text-align:center">{{ lvl[0] }}</span>
    </div>
    {% endfor %}
    <p style="font-size:12px;color:#9e9e9e;margin-top:16px">Click any row to open that pillar's detail tab.</p>
  {% else %}
    <div class="empty">No rating yet ‚Äî click "Re-rate with AI" to generate one.</div>
  {% endif %}
</div>


<!-- ‚ïê‚ïê‚ïê PILLAR MACRO (inline, repeated for each pillar) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

{% macro pillar_tab(tab_id, label, score, color, metrics, pa_key) %}
<div id="tab-{{ tab_id }}" class="tab-panel">

  <!-- Score hero -->
  {% set lvl = score_label(score) %}
  <div style="background:linear-gradient(135deg,#f8fafc 0%,{{ color }}11 100%);border-radius:12px;padding:24px;margin-bottom:24px;border-left:5px solid {{ color }}">
    <div style="font-size:11px;font-weight:800;color:#546e7a;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px">{{ label }}</div>
    <div style="display:flex;align-items:baseline;gap:6px;margin-bottom:12px">
      <span style="font-size:64px;font-weight:900;line-height:1;color:{{ color }}">{{ score|fmt_num(0) }}</span>
      <span style="font-size:22px;color:#9e9e9e;font-weight:400">/100</span>
      <span style="margin-left:8px;font-size:13px;font-weight:700;padding:4px 10px;border-radius:20px;
                   background:{{ lvl[1] }}22;color:{{ lvl[1] }}">{{ lvl[0] }}</span>
    </div>
    <div style="height:10px;background:#e0e0e0;border-radius:5px;overflow:hidden">
      <div style="height:100%;width:{{ score|fmt_num(0,'','') if score is not none else 0 }}%;background:{{ color }};border-radius:5px;transition:width .6s"></div>
    </div>
  </div>

  <!-- Data metrics grid -->
  {% if metrics %}
  <div class="fundamentals-grid mb-4">
    {% for mlabel, mvalue in metrics %}
    <div class="fundamental-card">
      <div class="fundamental-label">{{ mlabel }}</div>
      <div class="fundamental-value" style="font-size:20px">{{ mvalue }}</div>
      {% if f %}<div class="fundamental-year">{{ f.year }}</div>{% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- AI analysis -->
  {% set analysis = pa.get(pa_key, {}) %}
  {% if analysis and analysis.get('summary') %}
    <div style="background:#fffbf0;border:1px solid #f0e6c8;border-radius:10px;padding:20px;margin-bottom:20px">
      <div style="font-size:11px;font-weight:800;color:#946500;text-transform:uppercase;letter-spacing:1px;margin-bottom:14px">üìä Analysis</div>
      {% for para in analysis.get('summary','').split('\n\n') %}
        {% if para.strip() %}
          <p style="font-size:14px;line-height:1.85;color:#2d3748;margin-bottom:14px">{{ para.strip() }}</p>
        {% endif %}
      {% endfor %}
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Strengths -->
      <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:18px">
        <div style="font-size:13px;font-weight:800;color:#15803d;margin-bottom:12px">‚úì Strengths</div>
        <ul style="list-style:none">
          {% for s in analysis.get('strengths', []) %}
          <li style="font-size:13px;line-height:1.5;margin-bottom:8px;padding-left:18px;position:relative;color:#2d3748">
            <span style="position:absolute;left:0;color:#15803d;font-weight:700">‚úì</span>{{ s }}
          </li>
          {% endfor %}
        </ul>
      </div>
      <!-- Risks -->
      <div style="background:#fff1f2;border:1px solid #fecdd3;border-radius:10px;padding:18px">
        <div style="font-size:13px;font-weight:800;color:#be123c;margin-bottom:12px">‚ö† Risks</div>
        <ul style="list-style:none">
          {% for r in analysis.get('risks', []) %}
          <li style="font-size:13px;line-height:1.5;margin-bottom:8px;padding-left:18px;position:relative;color:#2d3748">
            <span style="position:absolute;left:0;color:#be123c;font-weight:700">!</span>{{ r }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% else %}
    <div class="empty" style="padding:32px">
      No detailed analysis yet ‚Äî click <strong>Re-rate with AI</strong> to generate pillar-level commentary.
    </div>
  {% endif %}
</div>
{% endmacro %}


<!-- ‚ïê‚ïê‚ïê ECONOMY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{{ pillar_tab(
  'economy', 'Economic Strength', country.score_economic, '#1565c0',
  [
    ('GDP Growth',      f.gdp_growth  | fmt_num(1, '%')   if f else '‚Äî'),
    ('GDP per Capita',  f.gdp_per_capita | fmt_num(0, '', '$') if f else '‚Äî'),
    ('Inflation',       f.inflation   | fmt_num(1, '%')   if f else '‚Äî'),
  ],
  'economic_strength'
) }}


<!-- ‚ïê‚ïê‚ïê FISCAL TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{{ pillar_tab(
  'fiscal', 'Fiscal Position', country.score_fiscal, '#6a1b9a',
  [
    ('Debt / GDP',      f.debt_gdp    | fmt_num(1, '%')   if f else '‚Äî'),
    ('Deficit / GDP',   f.deficit_gdp | fmt_num(1, '%')   if f else '‚Äî'),
  ],
  'fiscal_position'
) }}


<!-- ‚ïê‚ïê‚ïê EXTERNAL TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{{ pillar_tab(
  'external', 'External Position', country.score_external, '#00695c',
  [
    ('Current Account / GDP', f.ca_gdp          | fmt_num(1, '%')     if f else '‚Äî'),
    ('FX Reserves',           f.reserves_months | fmt_num(1, ' months') if f else '‚Äî'),
  ],
  'external_position'
) }}


<!-- ‚ïê‚ïê‚ïê MONETARY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{{ pillar_tab(
  'monetary', 'Monetary Policy', country.score_monetary, '#e65100',
  [
    ('Inflation',   f.inflation       | fmt_num(1, '%')     if f else '‚Äî'),
    ('FX Reserves', f.reserves_months | fmt_num(1, ' months') if f else '‚Äî'),
  ],
  'monetary_policy'
) }}


<!-- ‚ïê‚ïê‚ïê BANKING TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{{ pillar_tab(
  'banking', 'Banking Sector', country.score_banking, '#c62828',
  [],
  'banking_sector'
) }}


<!-- ‚ïê‚ïê‚ïê POLITICS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{{ pillar_tab(
  'politics', 'Political Governance', country.score_political, '#2e7d32',
  [],
  'political_governance'
) }}


<!-- ‚ïê‚ïê‚ïê HISTORY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-history" class="tab-panel card">
  {% if history %}
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Rating</th><th>Outlook</th>
          <th>Score</th><th>Econ</th><th>Fiscal</th><th>Ext</th><th>Mon</th><th>Bank</th><th>Pol</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody>
        {% for r in history %}
        <tr {% if loop.first %}style="background:#f0f7ff"{% endif %}>
          <td class="text-mono" style="font-size:12px;white-space:nowrap">
            {{ r.created_at|fmt_date }}
            {% if loop.first %}<span style="margin-left:5px;font-size:9px;background:#1565c0;color:#fff;padding:1px 5px;border-radius:3px">NOW</span>{% endif %}
          </td>
          <td><span class="rating-badge" style="background:{{ r.rating|rating_color }}">{{ r.rating }}</span></td>
          <td>{% if r.outlook %}<span class="outlook-badge" style="{{ r.outlook|outlook_style }}">{{ r.outlook }}</span>{% else %}‚Äî{% endif %}</td>
          <td class="text-mono" style="font-size:13px">{{ r.composite_score|fmt_num(1) }}</td>
          <td class="text-mono" style="font-size:12px;color:#546e7a">{{ r.score_economic|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:12px;color:#546e7a">{{ r.score_fiscal|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:12px;color:#546e7a">{{ r.score_external|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:12px;color:#546e7a">{{ r.score_monetary|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:12px;color:#546e7a">{{ r.score_banking|fmt_num(0) }}</td>
          <td class="text-mono" style="font-size:12px;color:#546e7a">{{ r.score_political|fmt_num(0) }}</td>
          <td style="font-size:12px;color:{% if r.source=='override' %}#e65100{% else %}#546e7a{% endif %}">{{ r.source }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="empty">No rating history yet.</div>
  {% endif %}
</div>


<!-- ‚ïê‚ïê‚ïê NEWS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-news" class="tab-panel card">
  {% if news %}
    {% for a in news %}
    <div class="news-item">
      <div class="news-headline">
        {% if a.url %}<a href="{{ a.url }}" target="_blank" rel="noopener" style="color:#0a1929">{{ a.headline }}</a>
        {% else %}{{ a.headline }}{% endif %}
      </div>
      <div class="news-meta">
        {% if a.source %}<span>{{ a.source }}</span>{% endif %}
        {% if a.published_at %}<span>{{ a.published_at|fmt_date }}</span>{% endif %}
        {% if a.sentiment is not none %}
          {% set s = a.sentiment %}
          <span class="{% if s > 0.1 %}sentiment-pos{% elif s < -0.1 %}sentiment-neg{% else %}sentiment-neu{% endif %}">
            {% if s > 0 %}+{% endif %}{{ "%.2f"|format(s) }}
          </span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="empty">No news cached yet. Click "Fetch News" in the top-right.</div>
  {% endif %}
</div>


<!-- ‚ïê‚ïê‚ïê OVERRIDE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="override-modal" class="modal-overlay" onclick="if(event.target===this)closeOverrideModal()">
  <div class="modal">
    <h2>Override Rating ‚Äî {{ country.name }}</h2>
    <div id="override-error" class="alert alert-error" style="display:none"></div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Rating</label>
        <select id="ov-rating" class="form-control">
          {% for r in ratings_scale %}<option value="{{ r }}"{% if r==country.rating %} selected{% endif %}>{{ r }}</option>{% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Outlook</label>
        <select id="ov-outlook" class="form-control">
          {% for o in outlooks %}<option value="{{ o }}"{% if o==country.outlook %} selected{% endif %}>{{ o }}</option>{% endfor %}
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Memory Title <span style="color:#9e9e9e;font-weight:400">(optional)</span></label>
      <input id="ov-title" class="form-control" placeholder="Override: {{ country.name }} ‚Äî ‚Ä¶">
    </div>

    <div class="form-group">
      <label class="form-label">Rationale <span style="color:#c62828">*</span></label>
      <textarea id="ov-rationale" class="form-control" placeholder="Explain the reasoning for this rating override‚Ä¶"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Tags <span style="color:#9e9e9e;font-weight:400">(comma-separated)</span></label>
      <input id="ov-tags" class="form-control" placeholder="e.g. sanctions, geopolitical, fiscal">
    </div>

    <div class="form-group">
      <label class="form-label">Also apply this rationale to (<span id="selected-count">0</span> selected)</label>
      <input id="country-search" class="form-control" placeholder="Search countries‚Ä¶"
             oninput="filterCountryPicker(this.value)" style="margin-bottom:6px">
      <div class="country-picker">
        {% for c in all_countries %}
        <div class="country-picker-item" data-id="{{ c.id }}" data-name="{{ c.name|lower }}"
             onclick="toggleCountry(this)">
          <input type="checkbox" style="flex-shrink:0;pointer-events:none">
          <span>{{ c.name }}</span>
          <span style="font-size:11px;color:#9e9e9e;margin-left:auto">{{ c.iso2 }}</span>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="flex gap-2 justify-between mt-4" style="padding-top:16px;border-top:1px solid #e2e8f0">
      <button class="btn btn-outline" onclick="closeOverrideModal()">Cancel</button>
      <button class="btn btn-orange" id="ov-submit" onclick="submitOverride('{{ country.iso2 }}')">Save Override</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById('tab-' + name);
  if (panel) panel.classList.add('active');
  if (btn) btn.classList.add('active');
  // Animate pillar bars into view
  panel && panel.querySelectorAll('[style*="width:"]').forEach(el => {
    const w = el.style.width; el.style.width='0'; setTimeout(()=>el.style.width=w, 50);
  });
}

// Open correct tab from URL hash
const tabFromHash = location.hash.replace('#','');
if (tabFromHash) {
  const btn = [...document.querySelectorAll('.tab-btn')].find(b => b.getAttribute('onclick').includes("'"+tabFromHash+"'"));
  if (btn) switchTab(tabFromHash, btn);
}

async function rerateWithAI(iso2) {
  const btn = document.getElementById('rerate-btn');
  const msg = document.getElementById('action-msg');
  btn.disabled = true; btn.textContent = '‚ü≥ Rating‚Ä¶';
  msg.className = 'alert alert-info';
  msg.textContent = 'Sending to GPT-4o‚Ä¶ this takes ~5 seconds.';
  msg.style.display = 'block';
  try {
    const r = await fetch(`/api/ratings/${iso2}/ai`, {method:'POST'});
    if (!r.ok) { const e = await r.json(); throw new Error(e.detail || r.statusText); }
    msg.textContent = 'Done! Reloading‚Ä¶';
    setTimeout(() => location.reload(), 600);
  } catch(e) {
    msg.className = 'alert alert-error';
    msg.textContent = 'Error: ' + e.message;
    btn.disabled = false; btn.textContent = '‚ü≥ Re-rate with AI';
  }
}

async function syncFundamentals(iso2) {
  const msg = document.getElementById('action-msg');
  msg.className = 'alert alert-info';
  msg.textContent = 'Syncing World Bank data‚Ä¶';
  msg.style.display = 'block';
  try {
    const r = await fetch(`/api/fundamentals/sync/${iso2}`, {method:'POST'});
    if (!r.ok) throw new Error(r.statusText);
    msg.textContent = 'Sync complete. Reloading‚Ä¶';
    setTimeout(() => location.reload(), 600);
  } catch(e) {
    msg.className = 'alert alert-error';
    msg.textContent = 'Sync failed: ' + e.message;
  }
}

async function fetchNews(iso2) {
  const msg = document.getElementById('action-msg');
  msg.className = 'alert alert-info';
  msg.textContent = 'Fetching news‚Ä¶';
  msg.style.display = 'block';
  try {
    const r = await fetch(`/api/news/fetch/${iso2}`, {method:'POST'});
    if (!r.ok) throw new Error(r.statusText);
    const d = await r.json();
    msg.textContent = `Fetched ${d.fetched} articles. Reloading‚Ä¶`;
    setTimeout(() => { location.hash='news'; location.reload(); }, 600);
  } catch(e) {
    msg.className = 'alert alert-error';
    msg.textContent = 'Fetch failed: ' + e.message;
  }
}

function openOverrideModal()  { document.getElementById('override-modal').classList.add('open'); }
function closeOverrideModal() { document.getElementById('override-modal').classList.remove('open'); }

function filterCountryPicker(q) {
  document.querySelectorAll('.country-picker-item').forEach(el => {
    el.style.display = !q || el.dataset.name.includes(q.toLowerCase()) ? '' : 'none';
  });
}

function toggleCountry(el) {
  el.classList.toggle('selected');
  el.querySelector('input').checked = el.classList.contains('selected');
  document.getElementById('selected-count').textContent =
    document.querySelectorAll('.country-picker-item.selected').length;
}

async function submitOverride(iso2) {
  const rationale = document.getElementById('ov-rationale').value.trim();
  const errEl = document.getElementById('override-error');
  if (!rationale) { errEl.textContent='Rationale is required.'; errEl.style.display='block'; return; }
  errEl.style.display = 'none';

  const selectedIds = [...document.querySelectorAll('.country-picker-item.selected')]
    .map(el => parseInt(el.dataset.id));

  const body = {
    rating:   document.getElementById('ov-rating').value,
    outlook:  document.getElementById('ov-outlook').value,
    title:    document.getElementById('ov-title').value.trim() || undefined,
    rationale,
    tags: document.getElementById('ov-tags').value.split(',').map(t=>t.trim()).filter(Boolean),
    applicable_country_ids: selectedIds,
  };

  const btn = document.getElementById('ov-submit');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  try {
    const r = await fetch(`/api/ratings/${iso2}/override`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    if (!r.ok) { const e = await r.json(); throw new Error(e.detail || r.statusText); }
    location.reload();
  } catch(e) {
    errEl.textContent = 'Error: ' + e.message;
    errEl.style.display = 'block';
    btn.disabled = false; btn.textContent = 'Save Override';
  }
}
</script>
{% endblock %}
